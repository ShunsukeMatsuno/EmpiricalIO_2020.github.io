---
title: "HW5"
author: "Shunsuke Matsuno (29-196070)"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output:
  html_document:
    code_folding: show
    df_print: paged
    number_sections: no
    theme: united
    toc: yes
    toc_float: no
  pdf_document:
    toc: yes
---

```{r settings, echo=FALSE}
### Setting the global code chunk options ###
# Args
#   comment='': won't append any string to the start of each line of results
#   fig.align='center': align figures to the center of document
knitr::opts_chunk$set(comment="", fig.align="center", warning = FALSE)
```

# Single Agent Dynamics

## Data
- Required libraries
```{r, message=FALSE}
easypackages::libraries(c('tidyverse', 'EmpiricalIO2020'))
```
- Load the data and name the columns.
```{r}
df <- read_csv('../input/data/PS2020GIO2data2.csv', col_names = FALSE) %>% 
  magrittr::set_colnames(c('firm', 'period', 'state', 'action'))
df
```

## Dynamic Problem
- Let $\theta_1 := (\kappa, \gamma)$, $\theta_2 := (\alpha, \beta)$, and $\theta := (\theta_1, \theta_2)$.

- The Bellman equaion for this problem is given by
$$
V_{\theta}(s,\varepsilon)=\max_{a\in\{0,1\}}\left\{ \pi^{m}(a,s)+\varepsilon_{a}+\delta E_{s',\varepsilon'\mid s,\varepsilon,a}V_{\theta}(s',\varepsilon')\right\} .
$$

- Letting $EV_{\theta}(a,s):=E_{s',\varepsilon'\mid s,\varepsilon,a}V_{\theta}(s',\varepsilon')$ and $v(a,s,\varepsilon\mid\theta):=\pi^{m}(a,s)+\delta EV_{\theta}(a,s,\varepsilon)$, we have

$$
V_{\theta}(s,\varepsilon)=\max\left\{ v(0,s,\varepsilon\mid\theta)+\varepsilon_{0},v(0,s,\varepsilon\mid\theta)+\varepsilon_{1}\right\} 
$$

- Notice that we used iid assumption on $\varepsilon$, so that $EV_\theta$ does not depend on $\varepsilon$.
 
    
## Estimate parameters
- Set seed number.
```{r}
set.seed(2020)
```

- I set the inital parameters as followings.
```{r}
alpha <- 2
beta <- 1
theta_2 <- c(alpha, beta)

delta <- 0.95
```

- First, I estimate the trainsition matrix.
- `HW5_estimate_G.R` returns $10 \times 5$ matrix, where:
    - 1st row: the transition probability when the firm take action $a = 0$ with state $s = 1$.
    - 2nd row: the transition probability when the firm take action $a = 1$ with state $s = 1$.
    - 3rd row: the transition probability when the firm take action $a = 0$ with state $s = 2$.
    - ...
    
```{r}
HW5_estimate_G(df)
```
- This is the estimated transition matrix of
$$
\begin{pmatrix}1 & 0 & 0 & 0 & 0\\
1-\gamma & \gamma & 0 & 0 & 0\\
\kappa & 1-\kappa & 0 & 0 & 0\\
\kappa & 1-\kappa-\gamma & \gamma & 0 & 0\\
0 & \kappa & 1-\kappa & 0 & 0\\
0 & \kappa & 1-\kappa-\gamma & \gamma & 0\\
0 & 0 & \kappa & 1-\kappa & 0\\
0 & 0 & \kappa & 1-\kappa-\gamma & \gamma\\
0 & 0 & 0 & \kappa & 1-\kappa\\
0 & 0 & 0 & \kappa & 1-\kappa
\end{pmatrix}
$$
- I estimate $\theta_1 = (\kappa, \gamma)$ by mean of each corresponding element of the estimate transition matrix.
```{r}
theta_1_est <- HW5_estimate_theta_1(df)
theta_1_est
```



- `HW_5_compute_PI.R` computes payoff for each pair of $(a,s)$.
```{r}
HW5_compute_PI(theta_2)
```

- By Nested Fixed Point Algorithm, we estimate the parameters that govern payoff.

- To do so, we start with computing $EV_\theta$.
    - For each $(a,s)$, we have the following expression of $EV_\theta$.

$$
\begin{align*}
EV_{\theta}(a,s) & =E_{s',\varepsilon'\mid a,s}\max_{a\in\{0,1\}}\left\{ \pi^{m}(a,s')+\varepsilon_{a}+\delta EV_{\theta}(a,s')\right\} \\
 & =E_{s'\mid a,s}E_{\varepsilon'\mid a,s,s'}\max_{a\in\{0,1\}}\left\{ \pi^{m}(a,s')+\varepsilon_{a}+\delta EV_{\theta}(a,s')\right\} \\
 & =E_{s'\mid a,s}\log\left\{ \exp(\pi^{m}(0,s')+\delta EV_{\theta}(0,s'))+\exp(\pi^{m}(1,s)+\delta EV_{\theta}(1,s'))\right\} \\
 & =\sum_{s'\in\{1,\dots,5\}}P(s'\mid a,s)\log\left\{ \exp(\pi^{m}(0,s')+\delta EV_{\theta}(0,s'))+\exp(\pi^{m}(1,s)+\delta EV_{\theta}(1,s'))\right\} 
\end{align*}
$$

- `HW5_compute_EV.R` returns $EV_\theta = (EV_\theta (a, s))_{a,s}.
```{r}
EV_est <- HW5_compute_EV(theta_2, delta, df)
EV_est
```

- `HW5_compute_ccp` computes EV and then computes choice probability by

$$
P(a=1\mid s;\theta)=\frac{\exp(\pi^{m}(1,s)+\delta EV_{\theta}(1.s))}{\exp(\pi^{m}(0,s)+\delta EV_{\theta}(0.s))+\exp(\pi^{m}(1,s)+\delta EV_{\theta}(1.s))}
$$


```{r}
ccp <- HW5_compute_ccp(theta_2, delta, df)
ccp
```
 
- `HW5_compute_likelihood.R` computes likelihood.
```{r}
HW5_compute_likelihood(theta_2, delta, df)
```

- Finally, we optimize w.r.t. $\theta_2$.
```{r, cache=TRUE}
optim_result <- optim(par = theta_2,
                      fn = HW5_compute_likelihood,
                      df = df,
                      delta = delta,
                      method = 'Nelder-Mead',
                      control = list(fnscale = -1))
optim_result
```
- See if the result is robust to the choice of initial $\theta_2$.\
    - We can see that the choice of initial values does not affect the result.
```{r, cache=TRUE}
optim_result <- optim(par = c(5, 10),
                      fn = HW5_compute_likelihood,
                      df = df,
                      delta = delta,
                      method = 'Nelder-Mead',
                      control = list(fnscale = -1))
optim_result
```

- In sum, we obtained
$$
\hat{\alpha}=0.54,\hat{\beta}=2.98,\hat{\kappa}=0.10,\hat{\gamma}=0.60
$$










